<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scan & Upload</title>
<style>
body { font-family:'Sarabun', sans-serif; text-align:center; padding:20px; background:#f5f5f5; }
input, button { padding:10px 20px; margin:10px; font-size:16px; border-radius:6px; }
button { background:#06C755; color:#fff; border:none; cursor:pointer; }
button:hover { background:#049645; }
#previewContainer { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:20px;}
.pageCanvas { border:1px solid #555; border-radius:8px; max-width:160px; }
</style>
</head>
<body>

<h2>üìÑ Smart Scanner</h2>
<input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
<br>
<button onclick="uploadAll()">Upload & Share</button>

<div id="previewContainer"></div>
<div id="result"></div>

<script>
let pagesArray = [];

document.getElementById('cameraInput').addEventListener('change', async e=>{
  const files = Array.from(e.target.files);
  pagesArray = [];
  document.getElementById('previewContainer').innerHTML = '';
  for(const file of files){
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img,0,0);

    // Smart Crop ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;
    let minX=canvas.width, minY=canvas.height, maxX=0, maxY=0;
    for(let y=0;y<canvas.height;y++){
      for(let x=0;x<canvas.width;x++){
        const i=(y*canvas.width+x)*4;
        const r=data[i], g=data[i+1], b=data[i+2];
        const brightness = (r+g+b)/3;
        if(brightness<200){
          if(x<minX) minX=x; if(x>maxX) maxX=x;
          if(y<minY) minY=y; if(y>maxY) maxY=y;
        }
      }
    }
    const w=maxX-minX, h=maxY-minY;
    const croppedCanvas = document.createElement('canvas');
    croppedCanvas.width=w; croppedCanvas.height=h;
    croppedCanvas.getContext('2d').drawImage(canvas,minX,minY,w,h,0,0,w,h);

    croppedCanvas.classList.add('pageCanvas');
    document.getElementById('previewContainer').appendChild(croppedCanvas);
    pagesArray.push(croppedCanvas);
  }
});

async function uploadAll(){
  if(pagesArray.length===0){ alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"); return; }
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
  const urls = [];
  for(const canvas of pagesArray){
    const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',1.0));
    const reader = new FileReader();
    const url = await new Promise((resolve,reject)=>{
      reader.onload = async ()=>{
        try{
          const response = await fetch('https://script.google.com/macros/s/AKfycbwIe0tbe3NPc0CTy162Zr1vEQc8ZKNYFlenQn7ryNsQgLoSYZEzQ3nnBYRV0ln_ZWNkrA/exec',{
            method:'POST',
            body:reader.result
          });
          const data = await response.json();
          resolve(data.url);
        }catch(err){ reject(err); }
      };
      reader.readAsDataURL(blob);
    });
    urls.push(url);
  }
  resultDiv.innerHTML = urls.map(u=>`<a href="${u}" target="_blank">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î / ‡πÅ‡∏ä‡∏£‡πå</a>`).join('<br>');
}
</script>

</body>
</html>
