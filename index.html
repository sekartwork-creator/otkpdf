<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Document Scanner</title>
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
<style>
body { font-family:'Sarabun',sans-serif; text-align:center; background:#f5f5f5; padding:20px;}
video, canvas { max-width:100%; border-radius:8px; margin-top:10px;}
button { padding:10px 20px; font-size:16px; margin:10px; border-radius:6px;}
</style>
</head>
<body>
<h2>üìÑ Smart Document Scanner</h2>
<p>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‚Üí ‡∏Ñ‡∏£‡∏≠‡∏õ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‚Üí ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>

<video id="video" autoplay playsinline></video><br>
<button id="snap">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
<canvas id="canvas"></canvas>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream => video.srcObject = stream)
.catch(err => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: "+err));

document.getElementById('snap').addEventListener('click', ()=> {
  // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å video ‡∏•‡∏á canvas
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // ‡∏£‡∏≠ OpenCV ‡πÇ‡∏´‡∏•‡∏î
  if(typeof cv === 'undefined'){
    alert('‡∏£‡∏≠ OpenCV ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  let src = cv.imread(canvas);
  let dst = new cv.Mat();
  let gray = new cv.Mat();
  let blurred = new cv.Mat();
  let edges = new cv.Mat();

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏ß-‡∏î‡∏≥
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY,0);
  // ‡πÄ‡∏ö‡∏•‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
  cv.GaussianBlur(gray, blurred, new cv.Size(5,5),0,0,cv.BORDER_DEFAULT);
  // ‡∏ï‡∏£‡∏ß‡∏à edge
  cv.Canny(blurred, edges, 75, 200);

  // ‡∏´‡∏≤‡∏Ç‡∏≠‡∏ö contour
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

  let maxArea = 0;
  let maxContour = null;
  for(let i=0;i<contours.size();i++){
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);
    if(area>maxArea){
      let peri = cv.arcLength(cnt,true);
      let approx = new cv.Mat();
      cv.approxPolyDP(cnt, approx, 0.02*peri,true);
      if(approx.rows===4){
        maxArea = area;
        maxContour = approx;
      }
    }
  }

  if(maxContour){
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á perspective transform
    let pts = [];
    for(let i=0;i<4;i++){
      pts.push({x:maxContour.data32S[i*2], y:maxContour.data32S[i*2+1]});
    }
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏∏‡∏î
    pts.sort((a,b)=>a.y-b.y);
    let top = pts.slice(0,2).sort((a,b)=>a.x-b.x);
    let bottom = pts.slice(2,4).sort((a,b)=>a.x-b.x);
    let ordered = [top[0], top[1], bottom[1], bottom[0]];

    let widthA = Math.hypot(ordered[2].x-ordered[3].x, ordered[2].y-ordered[3].y);
    let widthB = Math.hypot(ordered[1].x-ordered[0].x, ordered[1].y-ordered[0].y);
    let maxWidth = Math.max(widthA,widthB);

    let heightA = Math.hypot(ordered[1].x-ordered[2].x, ordered[1].y-ordered[2].y);
    let heightB = Math.hypot(ordered[0].x-ordered[3].x, ordered[0].y-ordered[3].y);
    let maxHeight = Math.max(heightA,heightB);

    let srcTri = cv.matFromArray(4,1,cv.CV_32FC2, [
      ordered[0].x, ordered[0].y,
      ordered[1].x, ordered[1].y,
      ordered[2].x, ordered[2].y,
      ordered[3].x, ordered[3].y
    ]);
    let dstTri = cv.matFromArray(4,1,cv.CV_32FC2, [
      0,0,
      maxWidth-1,0,
      maxWidth-1,maxHeight-1,
      0,maxHeight-1
    ]);
    let M = cv.getPerspectiveTransform(srcTri,dstTri);
    let dstWarp = new cv.Mat();
    cv.warpPerspective(src,dstWarp,M,new cv.Size(maxWidth,maxHeight));

    cv.imshow(canvas,dstWarp);
    dstWarp.delete(); M.delete(); srcTri.delete(); dstTri.delete();
  }

  // ‡∏•‡∏ö object
  src.delete(); dst.delete(); gray.delete(); blurred.delete(); edges.delete(); contours.delete(); hierarchy.delete();
});
</script>
</body>
</html>
