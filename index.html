<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner + PDF</title>
<!-- OpenCV -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: 'Sarabun', sans-serif; text-align:center; background:#f5f5f5; padding:20px; }
  canvas { border:1px solid #555; margin-top:10px; max-width:100%; border-radius:8px; }
  input, button { margin:10px; padding:10px 20px; font-size:16px; border-radius:6px; }
  button { background:#007bff; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#0056b3; }
</style>
</head>
<body>
<h2>üì∏ Scanner + PDF</h2>

<p>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡∏Ñ‡∏£‡∏≠‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
<input type="file" accept="image/*" capture="environment" id="cameraInput">

<p>‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏õ)</p>
<input type="file" accept="image/*" id="uploadInput">

<br>
<canvas id="canvas"></canvas>
<br>
<button id="savePDF">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentImage = null;

// ‡πÇ‡∏´‡∏•‡∏î OpenCV ‡πÄ‡∏™‡∏£‡πá‡∏à
let cvReady = false;
cv['onRuntimeInitialized']=()=>{ cvReady=true; console.log("OpenCV.js ready"); };

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏£‡∏≠‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function cropWithOpenCV(image) {
  if(!cvReady) {
    console.error("OpenCV.js ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
    return;
  }

  canvas.width = image.width;
  canvas.height = image.height;
  ctx.drawImage(image, 0, 0);

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  let edges = new cv.Mat();

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
  cv.GaussianBlur(gray, gray, new cv.Size(5,5),0,0,cv.BORDER_DEFAULT);
  cv.Canny(gray, edges, 50,150);

  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let biggest = null;
  let maxArea = 0;
  for(let i=0;i<contours.size();i++){
    let cnt = contours.get(i);
    let area = cv.contourArea(cnt);
    if(area>maxArea){ maxArea=area; biggest=cnt; }
  }

  if(biggest){
    let rect = cv.boundingRect(biggest);
    let crop = src.roi(rect);
    cv.imshow(canvas, crop);
    crop.delete();
  }

  src.delete(); gray.delete(); edges.delete(); contours.delete(); hierarchy.delete();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏ï‡∏¥
function displayImage(file){
  const img = new Image();
  img.onload = ()=>{
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
  }
  img.src = URL.createObjectURL(file);
}

// ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡∏Ñ‡∏£‡∏≠‡∏õ
document.getElementById('cameraInput').addEventListener('change', e=>{
  if(e.target.files.length>0){
    const img = new Image();
    img.onload = ()=>{ cropWithOpenCV(img); currentImage=img; }
    img.src = URL.createObjectURL(e.target.files[0]);
  }
});

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏õ
document.getElementById('uploadInput').addEventListener('change', e=>{
  if(e.target.files.length>0){
    displayImage(e.target.files[0]);
    currentImage = new Image();
    currentImage.src = URL.createObjectURL(e.target.files[0]);
  }
});

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
document.getElementById('savePDF').addEventListener('click', ()=>{
  if(!currentImage){
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
    return;
  }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const imgData = canvas.toDataURL("image/jpeg",1.0);
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

  pdf.addImage(imgData,'JPEG',0,10,pageWidth,pdfHeight);
  pdf.save("scanned.pdf");
});
</script>
</body>
</html>
