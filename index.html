<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Auto Crop Camera + Save PDF</title>
  <!-- OpenCV -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      font-family: 'Sarabun', sans-serif; 
      text-align: center; 
      background: #f9f9f9; 
      padding: 20px;
    }
    canvas { 
      margin-top: 15px; 
      border: 2px solid #555; 
      max-width: 100%; 
      border-radius: 10px;
    }
    input, button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #aaa;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏≠‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF</h2>
  
  <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
  <input type="file" accept="image/*" capture="environment" id="cameraInput">
  <p>‡∏´‡∏£‡∏∑‡∏≠</p>
  <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î -->
  <input type="file" accept="image/*" id="uploadInput">
  
  <br><br>
  <canvas id="canvas"></canvas>
  <br>
  <button id="savePDF">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function processImage(file, doCrop) {
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        if (!doCrop) return; // ‚ùå ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏õ‡∏Å‡πá‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ

        cv['onRuntimeInitialized'] = () => {
          let src = cv.imread(canvas);
          let gray = new cv.Mat();
          let edges = new cv.Mat();

          // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥ + ‡πÄ‡∏ö‡∏•‡∏≠ + ‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
          cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);
          cv.Canny(gray, edges, 50, 150);

          // ‡∏´‡∏≤ Contours
          let contours = new cv.MatVector();
          let hierarchy = new cv.Mat();
          cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

          // ‡∏´‡∏≤ contour ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î
          let biggest = null;
          let maxArea = 0;
          for (let i = 0; i < contours.size(); i++) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            if (area > maxArea) {
              maxArea = area;
              biggest = cnt;
            }
          }

          if (biggest) {
            let rect = cv.boundingRect(biggest);
            let crop = src.roi(rect);
            cv.imshow(canvas, crop);
            crop.delete();
          }

          // cleanup
          src.delete(); gray.delete(); edges.delete();
          contours.delete(); hierarchy.delete();
        };
      };
      img.src = URL.createObjectURL(file);
    }

    // ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡∏Ñ‡∏£‡∏≠‡∏õ
    document.getElementById('cameraInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        processImage(e.target.files[0], true); // ‚úÖ ‡∏Ñ‡∏£‡∏≠‡∏õ
      }
    });

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‚Üí ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏õ
    document.getElementById('uploadInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        processImage(e.target.files[0], false); // ‚ùå ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏õ
      }
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF
    document.getElementById('savePDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const imgData = canvas.toDataURL("image/jpeg", 1.0);

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ PDF
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pageWidth;
      const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;

      pdf.addImage(imgData, 'JPEG', 0, 10, pdfWidth, pdfHeight);
      pdf.save("scanned.pdf");
    });
  </script>
</body>
</html>
